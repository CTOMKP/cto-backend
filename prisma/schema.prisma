// Prisma schema for CTO Marketplace backend
// Datasource: PostgreSQL database named cto_db
// Generator: Prisma Client for TypeScript

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Keeping existing User model shape (Int id) to avoid breaking auth
model User {
  id              Int           @id @default(autoincrement())
  name            String?
  email           String        @unique
  passwordHash    String?
  role            UserRole      @default(USER)
  // OAuth provider fields
  provider        String?
  providerId      String?       @unique
  // Circle identity fields (legacy)
  circleUserId    String?       @unique
  circleAppId     String?
  circlePinStatus String?
  // Privy identity fields
  privyUserId     String?       @unique
  privyDid        String?       @unique
  lastLoginAt     DateTime?
  // Profile fields
  avatarUrl       String?        // Profile picture URL
  bio             String?        // User bio

  // Relations
  wallets         Wallet[]
  scanResults     ScanResult[]
  userListings    UserListing[]
  uploadedMemes   Meme[]
  payments        Payment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// Extend ScanResult with fields needed by marketplace while retaining Int id
model ScanResult {
  id              Int      @id @default(autoincrement())
  contractAddress String
  resultData      Json
  riskScore       Int?
  tier            String?
  summary         String?
  indexed         Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contractAddress])
  @@index([userId])
  @@index([riskScore])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum Chain {
  SOLANA
  ETHEREUM
  BSC
  SUI
  BASE
  APTOS      // Keep for backward compatibility
  MOVEMENT   // NEW - Movement Network (Aptos-compatible)
  NEAR
  OSMOSIS
  OTHER
  UNKNOWN
}

enum ListingCategory {
  MEME
  DEFI
  NFT
  OTHER
  UNKNOWN
}

// Listing table (renamed from MarketplaceListing)
model Listing {
  id              String          @id @default(cuid())
  contractAddress String          @unique
  chain           Chain           @default(SOLANA)
  category        ListingCategory @default(MEME)
  symbol          String?
  name            String?
  summary         String?
  riskScore       Int?
  communityScore  Float?
  tier            String?
  priceUsd        Float?
  change1m        Float?  // 1 minute price change percentage
  change5m        Float?  // 5 minute price change percentage
  change1h        Float?
  change6h        Float?
  change24h       Float?
  liquidityUsd    Float?
  marketCap       Float?
  volume24h       Float?
  holders         Int?
  age             String?
  txCount1h       Int?
  txCount24h      Int?
  metadata        Json?
  lastScannedAt   DateTime?
  vetted          Boolean         @default(false)  // Track if token has undergone Pillar 1 (risk scoring)
  
  // New filter fields
  lpBurnedPercentage     Float?    // LP burned percentage (0-100)
  top10HoldersPercentage  Float?    // Top 10 holders percentage (0-100)
  mintAuthDisabled       Boolean?  // Mint authority disabled
  raidingDetected        Boolean?  // Raiding activity detected
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Back-relations

  @@index([chain])
  @@index([category])
  @@index([tier])
  @@index([riskScore])
  @@index([lastScannedAt])
}

// Circle Wallets persisted for users
model Wallet {
  id                   String   @id @default(cuid())        // internal id
  circleWalletId       String?  @unique                     // Circle wallet id (legacy)
  privyWalletId        String?                              // Privy wallet id
  address              String?
  blockchain           Chain
  type                 String?                              // e.g., USER_CONTROLLED, PRIVY_EMBEDDED, PRIVY_EXTERNAL
  walletClient         String?                              // e.g., metamask, phantom, coinbase_wallet, APTOS_EMBEDDED
  description          String?
  isPrimary            Boolean  @default(false)             // Primary wallet for the user
  encryptedPrivateKey  String?                              // Encrypted private key for server-managed wallets (Aptos)

  userId         Int
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  walletBalances WalletBalance[]
  walletTransactions WalletTransaction[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([blockchain])
  @@index([address])
}

// User-created listings
model UserListing {
  id           String   @id @default(cuid())
  userId       Int
  contractAddr String
  chain        String
  title        String
  description  String
  bio          String?
  logoUrl      String?
  bannerUrl    String?
  links        Json?
  status       String   // DRAFT | PENDING_APPROVAL | PUBLISHED | REJECTED
  vettingTier  String
  vettingScore Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  boosts AdBoost[]

  @@index([status])
  @@index([userId])
}

model AdBoost {
  id           String   @id @default(cuid())
  listingId    String
  type         String   // top, priority, bump, spotlight, homepage, urgent
  durationDays Int
  startDate    DateTime @default(now())
  endDate      DateTime
  createdAt    DateTime @default(now())

  // Relations
  listing UserListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

// Meme images uploaded by admins (public access)
model Meme {
  id           String   @id @default(cuid())
  filename     String   // Original filename
  s3Key        String   @unique  // S3 object key (memes/filename_timestamp.jpg)
  s3Url        String   // Direct public S3 URL
  size         Int      // File size in bytes
  mimeType     String   // image/jpeg, image/png, etc.
  description  String?  // Optional description
  category     String?  // Optional category/tag
  
  // Admin who uploaded
  uploadedById Int
  uploadedBy   User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([uploadedById])
  @@index([createdAt])
}

// Waitlist emails
model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  
  @@index([createdAt])
}

// Payment tracking for listings and ad boosts
model Payment {
  id                String        @id @default(cuid())
  userId            Int
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Payment type and related entity
  paymentType       PaymentType   // LISTING | AD_BOOST
  listingId         String?       // Reference to UserListing
  adBoostId         String?       // Reference to AdBoost
  
  // Payment details
  amount            Float
  currency          String        @default("USDC")
  status            PaymentStatus @default(PENDING)
  
  // Circle transaction details
  transferId        String?       @unique  // Circle transfer ID
  txHash            String?                // Blockchain transaction hash
  fromWalletId      String?                // Source wallet (user's wallet)
  toAddress         String?                // Destination address (platform wallet)
  
  // Metadata
  description       String?
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  completedAt       DateTime?
  
  // Relations
  walletTransactions WalletTransaction[]
  
  @@index([userId])
  @@index([paymentType])
  @@index([status])
  @@index([transferId])
  @@index([listingId])
  @@index([adBoostId])
}

enum PaymentType {
  LISTING
  AD_BOOST
  ESCROW
  WITHDRAWAL
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// Movement wallet balance tracking
model WalletBalance {
  id            String   @id @default(cuid())
  walletId      String   // Reference to Wallet.id
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Token details
  tokenAddress  String   // Movement test token contract address
  tokenSymbol   String   // e.g., "MOV", "TEST"
  tokenName     String?  // Full token name
  decimals      Int      @default(8) // Movement token decimals
  
  // Balance
  balance       String   @default("0") // Stored as string to handle large numbers
  balanceUsd    Float?   // USD value if available
  
  // Metadata
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([walletId, tokenAddress])
  @@index([walletId])
  @@index([tokenAddress])
}

// Movement wallet transaction history
model WalletTransaction {
  id            String   @id @default(cuid())
  walletId      String   // Reference to Wallet.id
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction details
  txHash        String   // Movement transaction hash
  txType        String   // CREDIT | DEBIT | TRANSFER
  amount        String   // Amount as string
  tokenAddress  String   // Token contract address
  tokenSymbol   String   // Token symbol
  
  // Transaction parties
  fromAddress   String?  // Sender address
  toAddress     String?  // Recipient address
  
  // Related entities
  paymentId     String?  // Reference to Payment.id if this is a payment
  payment       Payment?  @relation(fields: [paymentId], references: [id])
  
  // Status
  status        String   @default("COMPLETED") // PENDING | COMPLETED | FAILED
  blockNumber   String?  // Block number
  blockTime     DateTime? // Block timestamp
  
  // Metadata
  description   String?
  metadata      Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([walletId, txHash])
  @@index([walletId])
  @@index([txHash])
  @@index([paymentId])
  @@index([txType])
  @@index([createdAt])
}

// Pillar 2: Monitoring snapshots for continuous tracking
model MonitoringSnapshot {
  id                String   @id @default(cuid())
  contractAddress   String   // Reference to Listing.contractAddress
  scannedAt         DateTime @default(now())
  
  // Current state
  currentTier       String?
  
  // Market metrics
  price             Float?   @default(0)
  marketCap         Float?   @default(0)
  liquidity         Float?   @default(0)
  volume24h         Float?   @default(0)
  priceChange24h    Float?   @default(0)
  
  // Holder metrics
  totalHolders      Int?     @default(0)
  holderChange24h   Int?     @default(0)
  topHolderPct      Float?   @default(0)
  top10HoldersPct   Float?   @default(0)
  
  // Activity metrics
  txns24h           Int?     @default(0)
  buys24h           Int?     @default(0)
  sells24h          Int?     @default(0)
  uniqueWallets24h  Int?     @default(0)
  
  // Trends
  liquidityTrend    String?  // 'increasing' | 'decreasing' | 'stable'
  holderTrend       String?  // 'increasing' | 'decreasing' | 'stable'
  activityTrend     String?  // 'increasing' | 'decreasing' | 'stable'
  
  // Raw data for reference
  rawData           Json?
  
  createdAt         DateTime @default(now())
  
  @@index([contractAddress])
  @@index([scannedAt])
}

// Pillar 2: Alerts detected during monitoring
model Alert {
  id                  String   @id @default(cuid())
  contractAddress     String   // Reference to Listing.contractAddress
  severity            String   // 'low' | 'medium' | 'high' | 'critical'
  triggerType         String   // 'liquidity_drop' | 'holder_loss' | 'price_crash' | etc.
  conditionDescription String? // Human-readable description of what triggered the alert
  actionTaken         String?  // What action was taken (e.g., 'monitoring_detected', 'tier_downgraded')
  message             String?  // Alert message
  detected            Boolean  @default(true)
  resolved            Boolean  @default(false)
  resolvedAt          DateTime?
  resolvedBy          Int?     // User ID who resolved it (if manual)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([contractAddress])
  @@index([severity])
  @@index([triggerType])
  @@index([detected])
  @@index([createdAt])
}